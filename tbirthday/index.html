<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›”ë³„ ìƒì¼ì ëª©ë¡</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.8/static/pretendard.css">
    <script src="https://unpkg.com/solarlunar@2.0.4/lib/solarlunar.min.js" 
            onload="console.log('solarlunar.js ë¡œë“œ ì™„ë£Œ', typeof solarLunar, typeof solarlunar, typeof window.solarLunar, typeof window.solarlunar);"
            onerror="console.error('solarlunar.js ë¡œë“œ ì‹¤íŒ¨. ìŒë ¥ ë³€í™˜ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #F2F4F6;
            color: #1A1A1A;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* í—¤ë” ì„¹ì…˜ */
        .header-section {
            padding: 48px 20px 32px;
            background: linear-gradient(180deg, #FFFFFF 0%, #F2F4F6 100%);
        }

        .page-title {
            font-size: 34px;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 400;
            color: #8E8E93;
            margin-bottom: 0;
        }

        /* í•„í„° ì„¹ì…˜ */
        .filter-section {
            padding: 0 20px 24px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .filter-stats {
            font-size: 15px;
            font-weight: 600;
            color: #1A1A1A;
        }

        .reset-button {
            background: none;
            border: none;
            color: #8E8E93;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }

        .reset-button:active {
            background-color: #E5E5EA;
            color: #1A1A1A;
        }

        .filter-controls {
            display: flex;
            gap: 12px;
        }

        .select-group {
            flex: 1;
        }

        select {
            width: 100%;
            height: 52px;
            padding: 0 16px;
            border-radius: 16px;
            border: 1px solid #E5E5EA;
            background-color: #FFFFFF;
            font-size: 16px;
            font-weight: 500;
            color: #1A1A1A;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 48px;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        select:active {
            transform: scale(0.98);
        }

        /* ìƒì¼ ë¦¬ìŠ¤íŠ¸ */
        .birthday-list {
            padding: 0 20px 32px;
        }

        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 12px;
            background-color: #FFFFFF;
            border-radius: 24px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            animation: fadeInUp 0.4s ease-out backwards;
        }

        .birthday-item:active {
            transform: scale(0.98);
            background-color: #F9F9F9;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ì˜¤ëŠ˜ ìƒì¼ íŠ¹ë³„ í‘œì‹œ */
        .birthday-item.today {
            background: linear-gradient(135deg, #FFF5E6 0%, #FFE8CC 100%);
            border: 2px solid #FFD700;
        }

        .birthday-item.today::before {
            content: 'ğŸ‰';
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 20px;
        }

        .person-info {
            flex: 1;
            min-width: 0;
        }

        .name-position {
            font-size: 18px;
            font-weight: 700;
            color: #1A1A1A;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }

        .department {
            font-size: 13px;
            font-weight: 400;
            color: #8E8E93;
        }

        .birthday-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
            min-width: 100px;
        }

        .birthday-info.solar {
            font-size: 16px;
            font-weight: 600;
            color: #1A1A1A;
        }

        .birthday-info.lunar {
            gap: 4px;
        }

        .lunar-original {
            font-size: 11px;
            font-weight: 400;
            color: #8E8E93;
            line-height: 1.4;
        }

        .lunar-converted {
            font-size: 16px;
            font-weight: 600;
            color: #1A1A1A;
        }

        .no-birthdays {
            text-align: center;
            padding: 64px 20px;
            color: #8E8E93;
            font-size: 15px;
            background-color: #FFFFFF;
            border-radius: 24px;
        }

        /* ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ */
        .loading {
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #E5E5EA;
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 15px;
            color: #8E8E93;
            font-weight: 500;
        }

        /* ìŠ¤ì¼ˆë ˆí†¤ UI */
        .skeleton-item {
            padding: 20px;
            margin-bottom: 12px;
            background-color: #FFFFFF;
            border-radius: 24px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .skeleton-line {
            height: 16px;
            background: linear-gradient(90deg, #E5E5EA 0%, #F2F4F6 50%, #E5E5EA 100%);
            background-size: 200% 100%;
            border-radius: 8px;
            margin-bottom: 8px;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-line.short {
            width: 60%;
        }

        /* íƒ€ì„ìŠ¤íƒ¬í”„ */
        .timestamp {
            text-align: center;
            font-size: 12px;
            color: #8E8E93;
            padding: 24px 20px 32px;
            font-weight: 400;
        }

        /* ì¬ì‹œë„ ë²„íŠ¼ */
        .retry-button {
            background-color: #007AFF;
            color: #FFFFFF;
            border: none;
            border-radius: 16px;
            padding: 14px 28px;
            margin-top: 16px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .retry-button:active {
            transform: scale(0.96);
            background-color: #0051D5;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 480px) {
            .header-section {
                padding: 40px 16px 24px;
            }

            .page-title {
                font-size: 28px;
            }

            .filter-section {
                padding: 0 16px 20px;
            }

            .birthday-list {
                padding: 0 16px 24px;
            }

            .birthday-item {
                padding: 18px;
                margin-bottom: 10px;
            }

            .filter-controls {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* ì ‘ê·¼ì„± ê°œì„  */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1 class="page-title">ìƒì¼ì ëª©ë¡</h1>
        <p class="section-title">ì´ë²ˆ ë‹¬ ìƒì¼ì„ ì¶•í•˜í•©ë‹ˆë‹¤</p>
    </div>
    
    <div class="filter-section">
        <div class="filter-header">
            <div class="filter-stats" id="filterStats">ì´ 0ëª…</div>
            <button id="resetFilters" class="reset-button">ì´ˆê¸°í™”</button>
        </div>
        <div class="filter-controls">
            <div class="select-group">
                <select id="monthSelect">
                    <option value="all">ì „ì²´ ì›”</option>
                    <option value="1">1ì›”</option>
                    <option value="2">2ì›”</option>
                    <option value="3">3ì›”</option>
                    <option value="4">4ì›”</option>
                    <option value="5">5ì›”</option>
                    <option value="6">6ì›”</option>
                    <option value="7">7ì›”</option>
                    <option value="8">8ì›”</option>
                    <option value="9">9ì›”</option>
                    <option value="10">10ì›”</option>
                    <option value="11">11ì›”</option>
                    <option value="12">12ì›”</option>
                </select>
            </div>
            <div class="select-group">
                <select id="departmentSelect">
                    <option value="all">ì „ì²´ ì†Œì†</option>
                    <option value="ì¥ë…„ë¶€">ì¥ë…„ë¶€</option>
                    <option value="ì²­ë…„ë¶€">ì²­ë…„ë¶€</option>
                    <option value="ê³ ë“±ë¶€">ê³ ë“±ë¶€</option>
                    <option value="ì¤‘ë“±ë¶€">ì¤‘ë“±ë¶€</option>
                    <option value="ì£¼ì¼í•™êµ">ì£¼ì¼í•™êµ</option>
                </select>
            </div>
        </div>
    </div>
    
    <div id="birthdayList" class="birthday-list"></div>
    
    <div class="timestamp" id="timestamp"></div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxJu7ulUmBlSrBkJnx5XB4v-PPzb4Z03HuLCXbGcb9fqRPrm9wxdYmoZGOwcxM64Jpk/exec';
        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        const CURRENT_YEAR = new Date().getFullYear(); // 2025ë…„
        let birthdayData = [];
        let cachedFilteredData = [];
        let isLoading = false;
        let libraryWarningShown = false; // ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ê³  ë©”ì‹œì§€ í•œ ë²ˆë§Œ í‘œì‹œ
        let solarLunarLibraryLoaded = false; // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ìƒíƒœ
        
        // ìŒë ¥ ë‚ ì§œë¥¼ ì˜¬í•´ ì–‘ë ¥ ë‚ ì§œë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function convertLunarToSolar(lunarDateStr, type) {
            if (type !== 'ìŒë ¥' && type !== 'ìŒ') {
                return null; // ì–‘ë ¥ì´ë©´ ë³€í™˜ ë¶ˆí•„ìš”
            }
            
            try {
                let lunarMonth = null;
                let lunarDay = null;
                
                // "2024. 2. 22" í˜•ì‹ì¸ ê²½ìš° (êµ¬ê¸€ ì‹œíŠ¸ í˜•ì‹)
                const dotFormatMatch = lunarDateStr.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
                if (dotFormatMatch) {
                    lunarMonth = parseInt(dotFormatMatch[2], 10);
                    lunarDay = parseInt(dotFormatMatch[3], 10);
                }
                // ISO í˜•ì‹ì¸ ê²½ìš° (ì˜ˆ: "2025-11-08T15:00:00.000Z")
                else if (lunarDateStr.includes('T') || lunarDateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                    const date = new Date(lunarDateStr);
                    if (!isNaN(date.getTime())) {
                        lunarMonth = date.getMonth() + 1;
                        lunarDay = date.getDate();
                    }
                } else {
                    // ë‚ ì§œ ë¬¸ìì—´ íŒŒì‹± (ì˜ˆ: "06ì›” 01ì¼" ë˜ëŠ” "06.01" ë˜ëŠ” "6.1")
                    const match = lunarDateStr.match(/(\d{1,2})[ì›”.\s]+(\d{1,2})/);
                    if (match) {
                        lunarMonth = parseInt(match[1], 10);
                        lunarDay = parseInt(match[2], 10);
                    }
                }
                
                if (!lunarMonth || !lunarDay) {
                    console.warn('ìŒë ¥ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨:', lunarDateStr);
                    return null;
                }
                
                // solarlunar.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ìŒë ¥ì„ ì–‘ë ¥ìœ¼ë¡œ ë³€í™˜
                // CDN ë²„ì „ì—ì„œëŠ” ì „ì—­ ë³€ìˆ˜ë¡œ ì ‘ê·¼ ê°€ëŠ¥
                let solar = null;
                
                // ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                if (!solarLunarLibraryLoaded && !checkSolarLunarLibrary()) {
                    // ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ null ë°˜í™˜ (ë‚˜ì¤‘ì— ì¬ì‹œë„)
                    return null;
                }
                
                // ì—¬ëŸ¬ ê°€ëŠ¥í•œ ì „ì—­ ë³€ìˆ˜ ì´ë¦„ ì‹œë„
                let lib = null;
                if (typeof solarLunar !== 'undefined' && solarLunar) {
                    lib = solarLunar;
                } else if (typeof solarlunar !== 'undefined' && solarlunar) {
                    lib = solarlunar;
                } else if (typeof window.solarLunar !== 'undefined' && window.solarLunar) {
                    lib = window.solarLunar;
                } else if (typeof window.solarlunar !== 'undefined' && window.solarlunar) {
                    lib = window.solarlunar;
                }
                
                if (lib) {
                    // lunarToSolar í•¨ìˆ˜ ì‹œë„
                    if (typeof lib.lunarToSolar === 'function') {
                        solar = lib.lunarToSolar(CURRENT_YEAR, lunarMonth, lunarDay);
                    } else if (typeof lib.lunar2solar === 'function') {
                        // lunar2solar í•¨ìˆ˜ ì‚¬ìš© (ë‹¤ë¥¸ ë²„ì „)
                        const result = lib.lunar2solar(CURRENT_YEAR, lunarMonth, lunarDay);
                        if (result && result.year && result.month && result.day) {
                            solar = { year: result.year, month: result.month, day: result.day };
                        }
                    }
                }
                
                if (!solar) {
                    // ê²½ê³  ë©”ì‹œì§€ëŠ” í•œ ë²ˆë§Œ ì¶œë ¥
                    if (!libraryWarningShown) {
                        console.warn('solarlunar.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŒë ¥ ë³€í™˜ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.', {
                            solarLunar: typeof solarLunar,
                            solarlunar: typeof solarlunar,
                            windowSolarLunar: typeof window.solarLunar,
                            windowSolarlunar: typeof window.solarlunar
                        });
                        libraryWarningShown = true;
                    }
                    return null;
                }
                
                if (solar && solar.year && solar.month && solar.day) {
                    // ë…„ë„ëŠ” ì˜¬í•´ë¡œ ê³ ì • (ì •ë ¬ì„ ìœ„í•´)
                    return new Date(CURRENT_YEAR, solar.month - 1, solar.day);
                }
                
                // ë³€í™˜ ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
                console.warn('ìŒë ¥ ë³€í™˜ ì‹¤íŒ¨:', { lunarMonth, lunarDay, solar });
                return null;
            } catch (error) {
                console.error('ìŒë ¥ ë³€í™˜ ì˜¤ë¥˜:', error, lunarDateStr);
                return null;
            }
        }
        
        // ë°ì´í„°ì— actualSolarDate ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function processBirthdayData(data) {
            if (!data || !Array.isArray(data)) {
                console.error('processBirthdayData: ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤', data);
                return [];
            }
            
            return data.map((person, index) => {
                // í•„ë“œëª… í™•ì¸ (êµ¬ê¸€ ì‹œíŠ¸ êµ¬ì¡°ì— ë§ê²Œ)
                // êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ê°€ ë°˜í™˜í•˜ëŠ” í•„ë“œ:
                // - birthday: ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œ (Iì—´)
                // - ìƒë…„ì›”ì¼ ê¸°ì´ˆ: ì›ë³¸ ìŒë ¥ ë‚ ì§œ (Fì—´)
                const rawBirthday = person.birthday || person.ìƒë…„ì›”ì¼ || person.ìƒì¼ || 
                                   person['Birthday'] || person['birthday'] || '';
                const type = person.type || person.ìŒì–‘ || person['ìŒ/ì–‘'] || person.lunar || 
                            person['Type'] || person['Lunar'] || '';
                
                // ì›ë³¸ ìŒë ¥ ë‚ ì§œ ì°¾ê¸° (êµ¬ê¸€ ì‹œíŠ¸ì˜ Fì—´: ìƒë…„ì›”ì¼ ê¸°ì´ˆ)
                // êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ì´ í•„ë“œë¥¼ ë°˜í™˜í•˜ê³  ìˆìŒ
                const originalLunarDate = person['ìƒë…„ì›”ì¼ ê¸°ì´ˆ'] || person['ìƒë…„ì›”ì¼ê¸°ì´ˆ'] || null;
                
                // ISO í˜•ì‹ì¸ ê²½ìš° "MMì›” DDì¼" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                let birthdayStr = '';
                let month = null;
                let day = null;
                
                if (typeof rawBirthday === 'string') {
                    // "2024. 2. 22" í˜•ì‹ì¸ ê²½ìš° (êµ¬ê¸€ ì‹œíŠ¸ í˜•ì‹)
                    const dotFormatMatch = rawBirthday.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
                    if (dotFormatMatch) {
                        month = parseInt(dotFormatMatch[2], 10);
                        day = parseInt(dotFormatMatch[3], 10);
                        birthdayStr = `${month}ì›” ${day}ì¼`;
                    }
                    // ISO í˜•ì‹ì¸ ê²½ìš° (ì˜ˆ: "2025-11-08T15:00:00.000Z")
                    else if (rawBirthday.includes('T') || rawBirthday.match(/^\d{4}-\d{2}-\d{2}/)) {
                        const date = new Date(rawBirthday);
                        if (!isNaN(date.getTime())) {
                            month = date.getMonth() + 1;
                            day = date.getDate();
                            birthdayStr = `${month}ì›” ${day}ì¼`;
                        }
                    } 
                    // ì´ë¯¸ "MMì›” DDì¼" í˜•ì‹ì¸ ê²½ìš°
                    else {
                        const match = rawBirthday.match(/(\d{1,2})[ì›”.\s]+(\d{1,2})/);
                        if (match) {
                            month = parseInt(match[1], 10);
                            day = parseInt(match[2], 10);
                            birthdayStr = rawBirthday;
                        } else {
                            birthdayStr = rawBirthday;
                        }
                    }
                } else if (rawBirthday instanceof Date) {
                    month = rawBirthday.getMonth() + 1;
                    day = rawBirthday.getDate();
                    birthdayStr = `${month}ì›” ${day}ì¼`;
                } else {
                    birthdayStr = String(rawBirthday || '');
                }
                
                
                let actualSolarDate = null;
                const isLunar = type === 'ìŒë ¥' || type === 'ìŒ' || type === 'lunar';
                
                if (isLunar) {
                    // ìŒë ¥ ìƒì¼ì¸ ê²½ìš°
                    // êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œë¥¼ birthday í•„ë“œë¡œ ë°˜í™˜í•˜ë¯€ë¡œ
                    // birthday í•„ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì˜¬í•´ ì–‘ë ¥ ë‚ ì§œë¡œ ë³€í™˜)
                    if (rawBirthday) {
                        // ISO í˜•ì‹ì¸ ê²½ìš°
                        if (typeof rawBirthday === 'string' && (rawBirthday.includes('T') || rawBirthday.match(/^\d{4}-\d{2}-\d{2}/))) {
                            const date = new Date(rawBirthday);
                            if (!isNaN(date.getTime())) {
                                // ì˜¬í•´ë¡œ ê³ ì •í•˜ì—¬ actualSolarDate ìƒì„± (ì •ë ¬ì„ ìœ„í•´)
                                actualSolarDate = new Date(CURRENT_YEAR, date.getMonth(), date.getDate());
                            }
                        } else if (rawBirthday instanceof Date) {
                            // Date ê°ì²´ì¸ ê²½ìš°
                            actualSolarDate = new Date(CURRENT_YEAR, rawBirthday.getMonth(), rawBirthday.getDate());
                        } else if (month && day) {
                            // ì´ë¯¸ íŒŒì‹±ëœ ê²½ìš°
                            actualSolarDate = new Date(CURRENT_YEAR, month - 1, day);
                        }
                    }
                } else {
                    // ì–‘ë ¥ ìƒì¼ì¸ ê²½ìš°
                    if (month && day) {
                        actualSolarDate = new Date(CURRENT_YEAR, month - 1, day);
                    } else {
                        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
                        const match = birthdayStr.match(/(\d{1,2})[ì›”.\s]+(\d{1,2})/);
                        if (match) {
                            month = parseInt(match[1], 10);
                            day = parseInt(match[2], 10);
                            actualSolarDate = new Date(CURRENT_YEAR, month - 1, day);
                        }
                    }
                }
                
                // ì›ë³¸ ìŒë ¥ ë‚ ì§œ ë³´ì¡´ (êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ë°˜í™˜í•¨)
                // birthday í•„ë“œ: ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œ
                // ìƒë…„ì›”ì¼ ê¸°ì´ˆ í•„ë“œ: ì›ë³¸ ìŒë ¥ ë‚ ì§œ
                let finalOriginalLunar = null;
                let convertedSolarStr = birthdayStr; // ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œ í‘œì‹œìš©
                
                if (isLunar) {
                    if (originalLunarDate) {
                        // ì›ë³¸ ìŒë ¥ ë‚ ì§œê°€ ë³„ë„ í•„ë“œë¡œ ì˜¨ ê²½ìš°
                        // "MMì›” DDì¼" í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”
                        let normalizedOriginal = originalLunarDate;
                        if (normalizedOriginal.includes('T') || normalizedOriginal.match(/^\d{4}-\d{2}-\d{2}/)) {
                            // ISO í˜•ì‹ì¸ ê²½ìš°
                            const date = new Date(normalizedOriginal);
                            if (!isNaN(date.getTime())) {
                                normalizedOriginal = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
                            }
                        } else if (normalizedOriginal.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/)) {
                            // "2024. 2. 22" í˜•ì‹ì¸ ê²½ìš°
                            const match = normalizedOriginal.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
                            if (match) {
                                normalizedOriginal = `${parseInt(match[2], 10)}ì›” ${parseInt(match[3], 10)}ì¼`;
                            }
                        }
                        finalOriginalLunar = normalizedOriginal;
                    }
                    
                    // ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œëŠ” birthday í•„ë“œì—ì„œ ê°€ì ¸ì˜´ (ì´ë¯¸ ë³€í™˜ë˜ì–´ ìˆìŒ)
                    // birthdayStrì´ ì´ë¯¸ ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                }
                
                return {
                    ...person,
                    birthday: birthdayStr, // "MMì›” DDì¼" í˜•ì‹ìœ¼ë¡œ ì €ì¥
                    originalLunarBirthday: finalOriginalLunar, // ìŒë ¥ ìƒì¼ìì˜ ì›ë³¸ ë‚ ì§œ ë³´ì¡´
                    type: type,
                    actualSolarDate: actualSolarDate,
                    isLunar: isLunar
                };
            });
        }
        
        // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (í‘œê¸° ë°©ì‹ ë³€ê²½)
        function formatDate(person) {
            // birthday í•„ë“œì—ì„œ ë‚ ì§œ ë¬¸ìì—´ ì¶”ì¶œ (ì›ë³¸ ë°ì´í„° ë³´ì¡´)
            let birthdayStr = person.birthday || person.ìƒë…„ì›”ì¼ || person.ìƒì¼ || person['ìƒë…„ì›”ì¼ ê¸°ì´ˆ'] || '';
            
            // ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë³€í™˜
            if (typeof birthdayStr !== 'string') {
                if (birthdayStr instanceof Date) {
                    // Date ê°ì²´ì¸ ê²½ìš° MMì›” DDì¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    const month = birthdayStr.getMonth() + 1;
                    const day = birthdayStr.getDate();
                    birthdayStr = `${month}ì›” ${day}ì¼`;
                } else {
                    birthdayStr = String(birthdayStr || '');
                }
            }
            
            // ISO ë‚ ì§œ í˜•ì‹ì¸ ê²½ìš° íŒŒì‹± (ì˜ˆ: "2024-02-21T15:00:00.000Z")
            if (birthdayStr.includes('T') || birthdayStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                try {
                    const date = new Date(birthdayStr);
                    if (!isNaN(date.getTime())) {
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        birthdayStr = `${month}ì›” ${day}ì¼`;
                    }
                } catch (e) {
                    console.warn('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', e, birthdayStr);
                }
            }
            
            // MMì›” DDì¼ í˜•ì‹ì´ ì•„ë‹Œ ê²½ìš° ì •ê·œí™” ì‹œë„
            if (!birthdayStr.includes('ì›”') && !birthdayStr.includes('ì¼')) {
                const match = birthdayStr.match(/(\d{1,2})[ì›”.\s\-/]+(\d{1,2})/);
                if (match) {
                    const month = parseInt(match[1], 10);
                    const day = parseInt(match[2], 10);
                    birthdayStr = `${month}ì›” ${day}ì¼`;
                }
            }
            
            // ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ì²˜ë¦¬
            if (!birthdayStr || birthdayStr.trim() === '') {
                birthdayStr = 'ë‚ ì§œ ì—†ìŒ';
            }
            
            if (person.isLunar) {
                // ìŒë ¥ ìƒì¼ì: ì›ë³¸ ìŒë ¥ ë‚ ì§œ + ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œ í•¨ê»˜ í‘œê¸°
                // ì›ë³¸ ìŒë ¥ ë‚ ì§œ: originalLunarBirthday ì‚¬ìš©
                // ë³€í™˜ëœ ì–‘ë ¥ ë‚ ì§œ: birthday í•„ë“œ ì‚¬ìš© (êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ë³€í™˜í•¨)
                const originalLunar = person.originalLunarBirthday || '';
                const convertedSolar = birthdayStr; // ì´ë¯¸ "MMì›” DDì¼" í˜•ì‹ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ìˆìŒ
                
                if (originalLunar && convertedSolar) {
                    // ë‘ ì¤„ë¡œ í‘œì‹œí•˜ê¸° ìœ„í•´ originalê³¼ converted ë¶„ë¦¬
                    return {
                        isLunar: true,
                        original: `ìŒë ¥ ${originalLunar}`,
                        converted: convertedSolar
                    };
                } else if (originalLunar) {
                    // ì›ë³¸ë§Œ ìˆëŠ” ê²½ìš°
                    return {
                        isLunar: true,
                        original: `ìŒë ¥ ${originalLunar}`,
                        converted: null
                    };
                } else {
                    // ì›ë³¸ì´ ì—†ëŠ” ê²½ìš° (fallback)
                    return {
                        isLunar: true,
                        original: `ìŒë ¥ ${birthdayStr}`,
                        converted: null
                    };
                }
            } else {
                // ì–‘ë ¥ ìƒì¼ì: ì–‘ë ¥ ë‚ ì§œë§Œ í‘œì‹œ (ì–‘ë ¥ í‘œì‹œ ì œê±°)
                return {
                    isLunar: false,
                    text: birthdayStr
                };
            }
        }

        function getMonthFromDate(person) {
            // actualSolarDateê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
            if (person.actualSolarDate) {
                try {
                    let date = null;
                    if (person.actualSolarDate instanceof Date) {
                        date = person.actualSolarDate;
                    } else if (typeof person.actualSolarDate === 'string') {
                        date = new Date(person.actualSolarDate);
                    } else {
                        // ë‹¤ë¥¸ í˜•ì‹ì¸ ê²½ìš°
                        date = new Date(person.actualSolarDate);
                    }
                    
                    if (date && !isNaN(date.getTime())) {
                        const month = date.getMonth() + 1;
                        return month;
                    }
                } catch (e) {
                    console.warn('getMonthFromDate actualSolarDate íŒŒì‹± ì˜¤ë¥˜:', e, person);
                }
            }
            
            // fallback: ì›ë˜ ë‚ ì§œì—ì„œ ì¶”ì¶œ
            const birthdayStr = String(person.birthday || person.ìƒë…„ì›”ì¼ || person.ìƒì¼ || person['ìƒë…„ì›”ì¼ ê¸°ì´ˆ'] || '');
            
            // "2024. 2. 22" í˜•ì‹ì¸ ê²½ìš° (êµ¬ê¸€ ì‹œíŠ¸ í˜•ì‹)
            const dotFormatMatch = birthdayStr.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
            if (dotFormatMatch) {
                return parseInt(dotFormatMatch[2], 10);
            }
            
            // MMì›” DDì¼ í˜•ì‹
            const match = birthdayStr.match(/(\d{1,2})[ì›”.\s]+/);
            if (match) {
                return parseInt(match[1], 10);
            }
            
            // ISO í˜•ì‹ì¸ ê²½ìš°
            if (birthdayStr.includes('T') || birthdayStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                try {
                    const date = new Date(birthdayStr);
                    if (!isNaN(date.getTime())) {
                        return date.getMonth() + 1;
                    }
                } catch (e) {
                    // ë¬´ì‹œ
                }
            }
            
            console.warn('getMonthFromDate: ì›”ì„ ì¶”ì¶œí•  ìˆ˜ ì—†ìŒ', person);
            return 0; // í•„í„°ë§ì—ì„œ ì œì™¸ë˜ë„ë¡ 0 ë°˜í™˜
        }

        // ë””ë°”ìš´ìŠ¤ ì²˜ë¦¬ë¥¼ ìœ„í•œ í•¨ìˆ˜
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ë¡œë”© ìƒíƒœ í‘œì‹œ í•¨ìˆ˜ (ìŠ¤ì¼ˆë ˆí†¤ UI)
        function showLoading() {
            isLoading = true;
            const birthdayList = document.getElementById('birthdayList');
            const skeletonCount = 5;
            let skeletonHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>';
            
            // ìŠ¤ì¼ˆë ˆí†¤ UI ìƒì„±
            skeletonHTML = '';
            for (let i = 0; i < skeletonCount; i++) {
                skeletonHTML += `
                    <div class="skeleton-item">
                        <div class="skeleton-line" style="width: 40%;"></div>
                        <div class="skeleton-line short" style="width: 25%;"></div>
                    </div>
                `;
            }
            
            birthdayList.innerHTML = skeletonHTML;
        }

        // í•„í„°ë§ ë° ì •ë ¬ì„ í•œë²ˆì— ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
        function filterBirthdays() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedDepartment = document.getElementById('departmentSelect').value;
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì„ íƒê°’ ì €ì¥
            localStorage.setItem('selectedMonth', selectedMonth);
            localStorage.setItem('selectedDepartment', selectedDepartment);
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¦¬í„´
            if (!birthdayData || !Array.isArray(birthdayData) || birthdayData.length === 0) {
                console.warn('í•„í„°ë§: ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                document.getElementById('birthdayList').innerHTML = 
                    '<div class="no-birthdays">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                return;
            }
            
            // ë³´ì—¬ì£¼ê¸° ì „ì— ë¡œë”© ìƒíƒœ í‘œì‹œ
            if (isLoading) {
                showLoading();
            }
            
            // UI ë Œë”ë§ì„ ë‹¤ìŒ í”„ë ˆì„ìœ¼ë¡œ ì§€ì—°
            requestAnimationFrame(() => {
                let filteredData = [...birthdayData]; // ì›ë³¸ ë°ì´í„° ë³µì‚¬
    
                // ì›” í•„í„°ë§ (actualSolarDate ê¸°ì¤€, ì—†ìœ¼ë©´ birthdayì—ì„œ ì¶”ì¶œ)
                if (selectedMonth !== 'all') {
                    const monthInt = parseInt(selectedMonth);
                    filteredData = filteredData.filter(person => {
                        const month = getMonthFromDate(person);
                        const matches = month === monthInt && month > 0;
                        return matches;
                    });
                }
    
                // ì†Œì† í•„í„°ë§
                if (selectedDepartment !== 'all') {
                    filteredData = filteredData.filter(person => {
                        const dept = person.ì†Œì† || person['ì†Œì†'] || '';
                        return dept === selectedDepartment;
                    });
                }
    
                // actualSolarDate ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ì˜¬í•´ ìƒì¼ì´ ë¹ ë¥¸ ìˆœì„œëŒ€ë¡œ)
                if (!arraysEqual(filteredData, cachedFilteredData)) {
                    filteredData.sort((a, b) => {
                        // actualSolarDateë¥¼ Date ê°ì²´ë¡œ ë³€í™˜ (ìºì‹œì—ì„œ ë¶ˆëŸ¬ì˜¬ ë•Œ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ)
                        let dateA = null;
                        let dateB = null;
                        
                        try {
                            if (a.actualSolarDate) {
                                if (a.actualSolarDate instanceof Date) {
                                    dateA = a.actualSolarDate;
                                } else {
                                    dateA = new Date(a.actualSolarDate);
                                }
                                // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œì¸ì§€ í™•ì¸
                                if (isNaN(dateA.getTime())) {
                                    dateA = null;
                                }
                            }
                        } catch (e) {
                            dateA = null;
                        }
                        
                        try {
                            if (b.actualSolarDate) {
                                if (b.actualSolarDate instanceof Date) {
                                    dateB = b.actualSolarDate;
                                } else {
                                    dateB = new Date(b.actualSolarDate);
                                }
                                // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œì¸ì§€ í™•ì¸
                                if (isNaN(dateB.getTime())) {
                                    dateB = null;
                                }
                            }
                        } catch (e) {
                            dateB = null;
                        }
                        
                        // actualSolarDateê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ì²˜ë¦¬
                        // nullì¸ ê²½ìš°ëŠ” birthdayì—ì„œ ì›”/ì¼ì„ ì¶”ì¶œí•˜ì—¬ ë¹„êµ (ì–‘ë ¥/ìŒë ¥ êµ¬ë¶„ ì—†ì´ í•¨ê»˜ ì •ë ¬)
                        if (!dateA && !dateB) {
                            // ë‘˜ ë‹¤ nullì´ë©´ birthdayë¡œ ë¹„êµ
                            const monthA = getMonthFromDate(a);
                            const monthB = getMonthFromDate(b);
                            if (monthA !== monthB) return monthA - monthB;
                            const dayA = parseInt((a.birthday || '').match(/(\d{1,2})ì¼/)?.[1] || '0', 10);
                            const dayB = parseInt((b.birthday || '').match(/(\d{1,2})ì¼/)?.[1] || '0', 10);
                            return dayA - dayB;
                        }
                        if (!dateA) {
                            // dateAê°€ nullì´ë©´ birthdayì—ì„œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                            const monthA = getMonthFromDate(a);
                            const monthB = dateB.getMonth() + 1;
                            if (monthA !== monthB) return monthA - monthB;
                            const dayA = parseInt((a.birthday || '').match(/(\d{1,2})ì¼/)?.[1] || '0', 10);
                            const dayB = dateB.getDate();
                            return dayA - dayB;
                        }
                        if (!dateB) {
                            // dateBê°€ nullì´ë©´ birthdayì—ì„œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                            const monthA = dateA.getMonth() + 1;
                            const monthB = getMonthFromDate(b);
                            if (monthA !== monthB) return monthA - monthB;
                            const dayA = dateA.getDate();
                            const dayB = parseInt((b.birthday || '').match(/(\d{1,2})ì¼/)?.[1] || '0', 10);
                            return dayA - dayB;
                        }
                        
                        // ë‚ ì§œ ë¹„êµ (ë…„ë„ ë¬´ì‹œ, ì›”/ì¼ë§Œ ë¹„êµ)
                        try {
                            // ë…„ë„ë¥¼ ì˜¬í•´ë¡œ ê³ ì •í•˜ì—¬ ë¹„êµ (ì •ë ¬ì„ ìœ„í•´)
                            const monthA = dateA.getMonth() + 1;
                            const dayA = dateA.getDate();
                            const monthB = dateB.getMonth() + 1;
                            const dayB = dateB.getDate();
                            
                            // ì›” ë¹„êµ
                            if (monthA !== monthB) {
                                return monthA - monthB;
                            }
                            // ì¼ ë¹„êµ
                            return dayA - dayB;
                        } catch (e) {
                            return 0;
                        }
                    });
                    
                    cachedFilteredData = filteredData;
                }
    
                renderBirthdayList(filteredData);
                isLoading = false;
            });
        }
        
        // ë°°ì—´ ë¹„êµ í•¨ìˆ˜
        function arraysEqual(a, b) {
            if (a === b) return true;
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // ë Œë”ë§ í•¨ìˆ˜ ë¶„ë¦¬ (í”„ë¦¬ë¯¸ì—„ ë””ìì¸ ì ìš©)
        function renderBirthdayList(data) {
            const birthdayList = document.getElementById('birthdayList');
            
            if (data.length === 0) {
                birthdayList.innerHTML = '<div class="no-birthdays">í•´ë‹¹í•˜ëŠ” ìƒì¼ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸ (ì˜¤ëŠ˜ ìƒì¼ì í‘œì‹œìš©)
            const today = new Date();
            const todayMonth = today.getMonth() + 1;
            const todayDay = today.getDate();
            
            // DOM ì¡°ì‘ ìµœì†Œí™”
            const fragment = document.createDocumentFragment();
            
            data.forEach((person, index) => {
                const item = document.createElement('div');
                item.className = 'birthday-item';
                
                // ì˜¤ëŠ˜ ìƒì¼ì¸ì§€ í™•ì¸
                if (person.actualSolarDate) {
                    try {
                        const date = person.actualSolarDate instanceof Date 
                            ? person.actualSolarDate 
                            : new Date(person.actualSolarDate);
                        if (!isNaN(date.getTime())) {
                            const personMonth = date.getMonth() + 1;
                            const personDay = date.getDate();
                            if (personMonth === todayMonth && personDay === todayDay) {
                                item.classList.add('today');
                            }
                        }
                    } catch (e) {
                        // ì˜¤ë¥˜ ë¬´ì‹œ
                    }
                }
                
                // ì• ë‹ˆë©”ì´ì…˜ ì§€ì—° ì ìš©
                item.style.animationDelay = `${index * 0.03}s`;
                
                const personInfo = document.createElement('div');
                personInfo.className = 'person-info';
                
                const namePosition = document.createElement('div');
                namePosition.className = 'name-position';
                namePosition.textContent = `${person.name}${person.position ? ' ' + person.position : ''}`;
                
                const department = document.createElement('div');
                department.className = 'department';
                department.textContent = person.ì†Œì† || '';
                
                personInfo.appendChild(namePosition);
                personInfo.appendChild(department);
                
                const birthdayInfo = document.createElement('div');
                const formattedDate = formatDate(person);
                
                // formatDateê°€ ê°ì²´ì¸ì§€ í™•ì¸
                if (formattedDate && typeof formattedDate === 'object' && 'isLunar' in formattedDate) {
                    if (formattedDate.isLunar) {
                        // ìŒë ¥ ìƒì¼ì: ë‘ ì¤„ë¡œ í‘œì‹œ
                        birthdayInfo.className = 'birthday-info lunar';
                        
                        const originalDiv = document.createElement('div');
                        originalDiv.className = 'lunar-original';
                        originalDiv.textContent = formattedDate.original || `ìŒë ¥ ${person.birthday || ''}`;
                        birthdayInfo.appendChild(originalDiv);
                        
                        if (formattedDate.converted) {
                            const convertedDiv = document.createElement('div');
                            convertedDiv.className = 'lunar-converted';
                            convertedDiv.textContent = formattedDate.converted;
                            birthdayInfo.appendChild(convertedDiv);
                        }
                    } else {
                        // ì–‘ë ¥ ìƒì¼ì: í•œ ì¤„ë¡œ í‘œì‹œ
                        birthdayInfo.className = 'birthday-info solar';
                        birthdayInfo.textContent = formattedDate.text || (person.birthday || '');
                    }
                } else {
                    // fallback: ë¬¸ìì—´ì¸ ê²½ìš° (ì´ì „ í˜•ì‹ í˜¸í™˜)
                    birthdayInfo.className = 'birthday-info solar';
                    const fallbackText = typeof formattedDate === 'string' ? formattedDate : (person.birthday || '');
                    birthdayInfo.textContent = fallbackText;
                }
                
                item.appendChild(personInfo);
                item.appendChild(birthdayInfo);
                fragment.appendChild(item);
            });
            
            // í•œ ë²ˆì— DOM ê°±ì‹ 
            birthdayList.innerHTML = '';
            birthdayList.appendChild(fragment);
            
            // í•„í„°ë§ ê²°ê³¼ í†µê³„ ì—…ë°ì´íŠ¸
            updateFilterStats(data.length);
        }
        
        // í•„í„°ë§ ê²°ê³¼ í†µê³„ í‘œì‹œ
        function updateFilterStats(count) {
            const stats = document.getElementById('filterStats');
            if (stats) {
                stats.textContent = `ì´ ${count}ëª…`;
            }
        }
        
        // ë””ë°”ìš´ìŠ¤ëœ í•„í„° í•¨ìˆ˜
        const debouncedFilter = debounce(filterBirthdays, 100);
        
        // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function setupEventListeners() {
            const monthSelect = document.getElementById('monthSelect');
            const departmentSelect = document.getElementById('departmentSelect');
            
            monthSelect.addEventListener('change', debouncedFilter);
            departmentSelect.addEventListener('change', debouncedFilter);
            
            // í•„í„° ë¦¬ì…‹ ë²„íŠ¼ ì´ë²¤íŠ¸
            const resetButton = document.getElementById('resetFilters');
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    monthSelect.value = 'all';
                    departmentSelect.value = 'all';
                    debouncedFilter();
                });
            }
        }

        // Date ê°ì²´ ë³µì› í•¨ìˆ˜ (ìºì‹œì—ì„œ ë¶ˆëŸ¬ì˜¬ ë•Œ ì‚¬ìš©)
        function restoreDateObjects(data) {
            if (!Array.isArray(data)) {
                console.warn('restoreDateObjects: ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤', data);
                return data;
            }
            return data.map((person, index) => {
                try {
                    if (person.actualSolarDate) {
                        // ì´ë¯¸ Date ê°ì²´ì¸ ê²½ìš°
                        if (person.actualSolarDate instanceof Date) {
                            // ìœ íš¨í•œì§€ í™•ì¸
                            if (isNaN(person.actualSolarDate.getTime())) {
                                return { ...person, actualSolarDate: null };
                            }
                            return person;
                        }
                        
                        // ë¬¸ìì—´ì´ë‚˜ ë‹¤ë¥¸ í˜•ì‹ì¸ ê²½ìš° Date ê°ì²´ë¡œ ë³€í™˜
                        const dateStr = person.actualSolarDate;
                        const date = new Date(dateStr);
                        
                        if (isNaN(date.getTime())) {
                            console.warn(`[${index}] ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:`, dateStr);
                            return { ...person, actualSolarDate: null };
                        }
                        
                        return {
                            ...person,
                            actualSolarDate: date
                        };
                    }
                    return person;
                } catch (error) {
                    console.error(`[${index}] Date ë³µì› ì˜¤ë¥˜:`, error, person);
                    return { ...person, actualSolarDate: null };
                }
            });
        }
        
        // localStorageì—ì„œ ìºì‹œëœ ë°ì´í„° í™•ì¸
        function getCachedData() {
            try {
                const cached = localStorage.getItem('birthdayDataCache');
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                const now = new Date().getTime();
                
                // 24ì‹œê°„ ì´ë‚´ì˜ ìºì‹œì¸ì§€ í™•ì¸
                if (now - timestamp < CACHE_DURATION) {
                    // Date ê°ì²´ ë³µì›
                    return restoreDateObjects(data);
                } else {
                    // ë§Œë£Œëœ ìºì‹œ ì‚­ì œ
                    localStorage.removeItem('birthdayDataCache');
                    return null;
                }
            } catch (error) {
                console.error('ìºì‹œ ì½ê¸° ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        // localStorageì— ë°ì´í„° ìºì‹±
        function setCachedData(data) {
            try {
                const cache = {
                    data: data,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('birthdayDataCache', JSON.stringify(cache));
            } catch (error) {
                console.error('ìºì‹œ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }
        
        // ë°ì´í„° ì´ˆê¸° ë¡œë“œ
        async function loadBirthdayData(forceRefresh = false) {
            // ìºì‹œëœ ë°ì´í„° í™•ì¸ (ê°•ì œ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹Œ ê²½ìš°ë§Œ)
            if (!forceRefresh) {
                const cachedData = getCachedData();
                if (cachedData && Array.isArray(cachedData) && cachedData.length > 0) {
                    // ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ì²˜ë¦¬
                    if (!solarLunarLibraryLoaded) {
                        waitForSolarLunarLibrary(() => {
                            // ìºì‹œì—ì„œ ë°ì´í„° ë¡œë“œ - processBirthdayDataë¡œ ë‹¤ì‹œ ì²˜ë¦¬
                            birthdayData = processBirthdayData(cachedData);
                            restoreFilterSettings();
                            filterBirthdays();
                            updateTimestamp();
                        });
                        return; // ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ê±´ë„ˆë›°ê¸°
                    } else {
                        // ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ë°”ë¡œ ì²˜ë¦¬
                        birthdayData = processBirthdayData(cachedData);
                        restoreFilterSettings();
                        filterBirthdays();
                        updateTimestamp();
                        return; // ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ê±´ë„ˆë›°ê¸°
                    }
                }
            } else {
                // ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œ ìºì‹œ ì‚­ì œ
                localStorage.removeItem('birthdayDataCache');
            }
            
            // ìºì‹œê°€ ì—†ê±°ë‚˜ ë§Œë£Œëœ ê²½ìš° ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ
            showLoading();
            
            try {
                // ìºì‹œ ë²„ìŠ¤íŒ…ì„ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                const timestamp = new Date().getTime();
                const url = `${scriptURL}?t=${timestamp}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
                }
                
                const data = await response.json();
                // ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ë³€í™˜
                let rawData = data.birthdays || data || [];
                
                if (!Array.isArray(rawData) || rawData.length === 0) {
                    throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
                }
                
                // ë°ì´í„° ê°€ê³µ: actualSolarDate ê³„ì‚°
                rawData = processBirthdayData(rawData);
                
                // ìºì‹œì— ì €ì¥
                setCachedData(rawData);
                
                birthdayData = rawData;
                
                // ì´ˆê¸° í•„í„° ê°’ ì„¤ì • (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µì›)
                restoreFilterSettings();
                
                // í•„í„° ì ìš©
                filterBirthdays();
                
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
                updateTimestamp();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message, error.stack);
                document.getElementById('birthdayList').innerHTML = 
                    `<div class="no-birthdays">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                    <small style="color: #999; margin-top: 8px; display: block;">ì˜¤ë¥˜: ${error.message}</small><br>
                    <button id="retryButton" class="retry-button">ë‹¤ì‹œ ì‹œë„</button></div>`;
                
                // ì¬ì‹œë„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const retryButton = document.getElementById('retryButton');
                if (retryButton) {
                    retryButton.addEventListener('click', () => loadBirthdayData(true)); // ê°•ì œ ìƒˆë¡œê³ ì¹¨
                }
            } finally {
                isLoading = false;
            }
        }
        
        // í•„í„° ì„¤ì • ë³µì›
        function restoreFilterSettings() {
            const monthSelect = document.getElementById('monthSelect');
            const departmentSelect = document.getElementById('departmentSelect');
            
            // ê¸°ë³¸ê°’: í˜„ì¬ ì›”, ì „ì²´ ë¶€ì„œ
            const currentMonth = new Date().getMonth() + 1;
            const savedMonth = localStorage.getItem('selectedMonth');
            const savedDepartment = localStorage.getItem('selectedDepartment');
            
            // ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            monthSelect.value = savedMonth || String(currentMonth);
            departmentSelect.value = savedDepartment || 'all';
        }
        
        // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = 
                `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }

        // ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ í•¨ìˆ˜
        function checkSolarLunarLibrary() {
            // solarlunar ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë‹¤ì–‘í•œ ì „ì—­ ë³€ìˆ˜ ì´ë¦„ í™•ì¸
            const checks = [
                typeof solarLunar !== 'undefined' && solarLunar && solarLunar.lunarToSolar,
                typeof solarlunar !== 'undefined' && solarlunar && solarlunar.lunarToSolar,
                typeof window.solarLunar !== 'undefined' && window.solarLunar && window.solarLunar.lunarToSolar,
                typeof window.solarlunar !== 'undefined' && window.solarlunar && window.solarlunar.lunarToSolar,
                typeof solarLunar !== 'undefined' && solarLunar && typeof solarLunar.lunar2solar === 'function',
                typeof solarlunar !== 'undefined' && solarlunar && typeof solarlunar.lunar2solar === 'function',
            ];
            return checks.some(check => check === true);
        }
        
        // solarlunar.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸ ë° ëŒ€ê¸°
        function waitForSolarLunarLibrary(callback) {
            let checked = false;
            
            const checkInterval = setInterval(() => {
                const hasLibrary = checkSolarLunarLibrary();
                
                if (hasLibrary && !checked) {
                    solarLunarLibraryLoaded = true;
                    checked = true;
                    clearInterval(checkInterval);
                    if (callback) callback();
                } else if (document.readyState === 'complete' && !checked) {
                    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ì—ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìœ¼ë©´ ê²½ê³ í•˜ì§€ë§Œ ê³„ì† ì§„í–‰
                    if (!hasLibrary) {
                        console.warn('solarlunar.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŒë ¥ ë³€í™˜ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    } else {
                        solarLunarLibraryLoaded = true;
                    }
                    checked = true;
                    clearInterval(checkInterval);
                    if (callback) callback();
                }
            }, 100);
            
            // 5ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ (ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ì–´ë„ ì§„í–‰)
            setTimeout(() => {
                if (!checked) {
                    const hasLibrary = checkSolarLunarLibrary();
                    if (!hasLibrary) {
                        console.warn('solarlunar.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ íƒ€ì„ì•„ì›ƒ. ìŒë ¥ ë³€í™˜ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    } else {
                        solarLunarLibraryLoaded = true;
                    }
                    checked = true;
                    clearInterval(checkInterval);
                    if (callback) callback();
                }
            }, 5000);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œë¥¼ ê¸°ë‹¤ë¦° í›„ ë°ì´í„° ë¡œë“œ
            waitForSolarLunarLibrary(() => {
                loadBirthdayData();
            });
        });
    </script>
</body>
</html>
