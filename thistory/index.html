<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¬ë€íŠ¸ ì „ì²´ ë‚´ì—­ - Firebase ë²„ì „</title>
    <!-- Firebase SDK ì¶”ê°€ -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* 
         * ë””ìì¸ ì‚¬ì–‘ì— ë§ì¶˜ CSS ë””ìì¸
         * ì»¬ëŸ¬ ìŠ¤í‚´:
         * - ì£¼ìš”ìƒ‰-1: #7B4AFF (rgb(123, 74, 255))
         * - ì¤‘ì„±-1: #F5F5F7 (rgb(245, 245, 247))
         * - ì¤‘ì„±-2: #DDDDDD (rgb(221, 221, 221))
         * - ì¤‘ì„±-3: #666666 (rgb(102, 102, 102))
         * - ì¤‘ì„±-4: #1A1A1A (rgb(26, 26, 26))
         */

        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #F5F5F7;
            line-height: 1.6;
            color: #666666;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(123, 74, 255, 0.1);
            margin-bottom: 24px;
        }

        .title {
            color: #7B4AFF;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 16px;
            text-align: center;
        }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 15px;
        }

        .filter-container {
            flex: 1;
        }

        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #1A1A1A;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 1px solid #DDDDDD;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Pretendard', sans-serif;
            color: #1A1A1A;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
            background-color: white;
        }

        select:focus, input:focus {
            border-color: #7B4AFF;
            box-shadow: 0 0 0 2px rgba(123, 74, 255, 0.1);
        }
        
        input[type="date"] {
            appearance: none;
            -webkit-appearance: none;
            padding-right: 12px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: transparent;
            cursor: pointer;
            color: #7B4AFF;
            opacity: 0.8;
        }

        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .filter-badge {
            background-color: rgba(123, 74, 255, 0.1);
            color: #7B4AFF;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-badge .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .clear-filters {
            background: none;
            border: none;
            color: #7B4AFF;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            margin-left: auto;
            font-weight: 500;
        }

        /* ì¹´ë“œí˜• ë‚ ì§œ ê·¸ë£¹ ìŠ¤íƒ€ì¼ë§ */
        .date-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .date-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(123, 74, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .date-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(123, 74, 255, 0.15);
        }

        .date-card-header {
            padding: 16px;
            background-color: rgba(123, 74, 255, 0.05);
            border-bottom: 1px solid rgba(123, 74, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .date-header-left {
            display: flex;
            flex-direction: column;
        }

        .date-text {
            font-weight: 600;
            font-size: 16px;
            color: #1A1A1A;
        }

        .date-day {
            color: #7B4AFF;
            font-size: 14px;
            font-weight: 500;
        }

        .date-count {
            background-color: rgba(123, 74, 255, 0.1);
            color: #7B4AFF;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }

        .history-list {
            flex-grow: 1;
            overflow: hidden;
        }

        .history-item {
            padding: 16px;
            border-bottom: 1px solid rgba(123, 74, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            flex-wrap: wrap;
            gap: 8px;
        }

        .history-item:hover {
            background-color: rgba(123, 74, 255, 0.03);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item.deleting {
            background-color: rgba(255, 74, 74, 0.05);
            opacity: 0.7;
        }

        .history-content {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            word-break: break-word;
        }

        .reason {
            font-weight: 500;
            color: #1A1A1A;
            font-size: 16px;
            white-space: normal;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .name {
            font-weight: 600;
        }

        .created-at {
            font-size: 12px;
            color: #666666;
            margin-top: 4px;
        }

        .talant {
            color: #7B4AFF;
            font-weight: bold;
            font-size: 18px;
            background-color: rgba(123, 74, 255, 0.1);
            padding: 6px 12px;
            border-radius: 10px;
            min-width: 60px;
            text-align: center;
            margin-left: 10px;
        }

        .actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 16px;
            opacity: 0.5;
            transition: opacity 0.2s;
            color: #666666;
        }

        .delete-btn:hover {
            opacity: 1;
            color: #FF4A4A;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(245, 245, 247, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(123, 74, 255, 0.2);
            border-top: 4px solid #7B4AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            color: #1A1A1A;
            font-weight: 500;
        }

        .empty-message {
            padding: 40px 20px;
            text-align: center;
            color: #666666;
            font-size: 16px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(123, 74, 255, 0.1);
        }

        .empty-icon {
            font-size: 48px;
            color: #DDDDDD;
            margin-bottom: 16px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(26, 26, 26, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1A1A1A;
        }

        .section-count {
            background-color: rgba(123, 74, 255, 0.1);
            color: #7B4AFF;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            padding: 20px;
            background-color: #FFF0F0;
            color: #FF4A4A;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 74, 74, 0.3);
        }

        .error-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .error-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .error-details {
            font-size: 14px;
            color: #666;
        }

        .retry-button {
            background-color: #7B4AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 12px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .retry-button:hover {
            background-color: #6A3AD8;
        }

        .mock-data-button {
            background-color: #F5F5F7;
            color: #666;
            border: 1px solid #DDDDDD;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 12px;
            margin-left: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .mock-data-button:hover {
            background-color: #EBEBED;
            border-color: #7B4AFF;
            color: #7B4AFF;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .date-cards {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .filters {
                flex-direction: column;
                gap: 12px;
            }

            .history-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .history-content {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .actions {
                width: 100%;
                justify-content: space-between;
            }

            .talant {
                font-size: 16px;
                padding: 4px 10px;
            }
            
            .title {
                font-size: 24px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .date-card-header {
                padding: 12px;
            }
            
            .reason {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ë‹¬ë€íŠ¸ ì „ì²´ ë‚´ì—­</h1>
            <div class="filters">
                <div class="filter-container">
                    <label class="filter-label" for="nameFilter">ì´ë¦„</label>
                    <select id="nameFilter">
                        <option value="">ì „ì²´ ì´ë¦„</option>
                    </select>
                </div>
                <div class="filter-container">
                    <label class="filter-label" for="dateFilterType">ê¸°ê°„ ìœ í˜•</label>
                    <select id="dateFilterType">
                        <option value="month">ì›”ë³„</option>
                        <option value="specific">íŠ¹ì • ë‚ ì§œ</option>
                    </select>
                </div>
                <div class="filter-container" id="monthFilterContainer">
                    <label class="filter-label" for="dateFilter">ì›” ì„ íƒ</label>
                    <select id="dateFilter">
                        <option value="">ì „ì²´ ê¸°ê°„</option>
                    </select>
                </div>
                <div class="filter-container" id="specificDateContainer" style="display: none;">
                    <label class="filter-label" for="specificDateFilter">ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" id="specificDateFilter" class="date-input">
                </div>
            </div>
            <div class="active-filters" id="activeFilters" style="display: none;">
                <!-- í™œì„±í™”ëœ í•„í„°ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                <button class="clear-filters" id="clearFilters">ëª¨ë“  í•„í„° ì§€ìš°ê¸°</button>
            </div>
        </div>

        <div id="errorContainer" style="display: none;"></div>

        <div class="section-header">
            <h2 class="section-title">ë‚´ì—­ ëª©ë¡</h2>
            <div class="section-count" id="recordCount">0ê°œ</div>
        </div>

        <div id="historyList">
            <!-- ë‚´ì—­ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBQhlKHBMGKuT95pM6kP6AH7Mv-xhJelBo",
            authDomain: "togy-web.firebaseapp.com",
            projectId: "togy-web",
            storageBucket: "togy-web.firebasestorage.app",
            messagingSenderId: "61696764840",
            appId: "1:61696764840:web:53096a4fe0ae1622e9cb9d"
        };

        // ê¸°ë³¸ ëª©ì—… ë°ì´í„° (Firebase ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
        const mockData = [
            {
                id: "mock1",
                name: "í™©ì¤€êµ¬",
                talant: "10",
                reason: "ì˜ˆë°° ì°¸ì„",
                receivedDate: new Date(2025, 2, 23), // 3ì›” 23ì¼
                timestamp: new Date(2025, 2, 23, 14, 30)
            },
            {
                id: "mock2",
                name: "ì„ë™í•˜",
                talant: "5",
                reason: "ì„±ê²½ ì•”ì†¡",
                receivedDate: new Date(2025, 2, 23), // 3ì›” 23ì¼
                timestamp: new Date(2025, 2, 23, 15, 45)
            },
            {
                id: "mock3",
                name: "ì •ì˜ˆë‹´",
                talant: "15",
                reason: "ì°¬ì–‘íŒ€ ì°¸ì—¬",
                receivedDate: new Date(2025, 2, 22), // 3ì›” 22ì¼
                timestamp: new Date(2025, 2, 22, 11, 20)
            },
            {
                id: "mock4",
                name: "ë°©ì‹œì˜¨",
                talant: "8",
                reason: "ë´‰ì‚¬ í™œë™",
                receivedDate: new Date(2025, 2, 21), // 3ì›” 21ì¼
                timestamp: new Date(2025, 2, 21, 16, 10)
            }
        ];

        // Firebase ë³€ìˆ˜ë“¤
        let db;
        let talantCollection;
        let firebaseInitialized = false;
        
        const people = ['ì„ë™í•˜', 'ì¥ì§€ë¯¼', 'í™©í¬', 'ê¹€ì¢…ì§„', 'ë°©ì‹œì˜¨', 'ì •ì˜ˆë‹´', 'ë°©ì˜¨ìœ ', 'ì •ì˜ˆì¤€'];
        let allHistory = [];
        let activeFilters = { name: '', date: '', specificDate: '' };
        let isUsingMockData = false;

        // ë¡œë”© í‘œì‹œ ë° ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showError(title, message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <div class="error-message">
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-title">${title}</div>
                    <div class="error-details">${message}</div>
                    <button class="retry-button" onclick="initializeFirebase()">ì¬ì‹œë„</button>
                    <button class="mock-data-button" onclick="useMockData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©í•˜ê¸°</button>
                </div>
            `;
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        function hideError() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.style.display = 'none';
        }

        // í™œì„± í•„í„° í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateActiveFilters() {
            const activeFiltersEl = document.getElementById('activeFilters');
            const hasActiveFilters = activeFilters.name || activeFilters.date || activeFilters.specificDate;
            
            if (!hasActiveFilters) {
                activeFiltersEl.style.display = 'none';
                return;
            }
            
            activeFiltersEl.style.display = 'flex';
            activeFiltersEl.innerHTML = '';
            
            if (activeFilters.name) {
                const badge = document.createElement('div');
                badge.className = 'filter-badge';
                badge.innerHTML = `ì´ë¦„: ${activeFilters.name} <span class="remove" data-filter="name">Ã—</span>`;
                activeFiltersEl.appendChild(badge);
                
                badge.querySelector('.remove').addEventListener('click', () => {
                    document.getElementById('nameFilter').value = '';
                    activeFilters.name = '';
                    updateActiveFilters();
                    applyFilters();
                    showToast('ì´ë¦„ í•„í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                });
            }
            
            if (activeFilters.date) {
                const [year, month] = activeFilters.date.split('-');
                const badge = document.createElement('div');
                badge.className = 'filter-badge';
                badge.innerHTML = `ê¸°ê°„: ${year}ë…„ ${month}ì›” <span class="remove" data-filter="date">Ã—</span>`;
                activeFiltersEl.appendChild(badge);
                
                badge.querySelector('.remove').addEventListener('click', () => {
                    document.getElementById('dateFilter').value = '';
                    activeFilters.date = '';
                    updateActiveFilters();
                    applyFilters();
                    showToast('ê¸°ê°„ í•„í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                });
            }
            
            if (activeFilters.specificDate) {
                const specificDate = new Date(activeFilters.specificDate);
                const year = specificDate.getFullYear();
                const month = specificDate.getMonth() + 1;
                const day = specificDate.getDate();
                
                const badge = document.createElement('div');
                badge.className = 'filter-badge';
                badge.innerHTML = `ë‚ ì§œ: ${year}ë…„ ${month}ì›” ${day}ì¼ <span class="remove" data-filter="specificDate">Ã—</span>`;
                activeFiltersEl.appendChild(badge);
                
                badge.querySelector('.remove').addEventListener('click', () => {
                    document.getElementById('specificDateFilter').value = '';
                    activeFilters.specificDate = '';
                    updateActiveFilters();
                    applyFilters();
                    showToast('ë‚ ì§œ í•„í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                });
            }
            
            const clearBtn = document.createElement('button');
            clearBtn.className = 'clear-filters';
            clearBtn.id = 'clearFilters';
            clearBtn.textContent = 'ëª¨ë“  í•„í„° ì§€ìš°ê¸°';
            activeFiltersEl.appendChild(clearBtn);
            
            clearBtn.addEventListener('click', () => {
                document.getElementById('nameFilter').value = '';
                document.getElementById('dateFilter').value = '';
                document.getElementById('specificDateFilter').value = '';
                activeFilters = { name: '', date: '', specificDate: '' };
                updateActiveFilters();
                applyFilters();
                showToast('ëª¨ë“  í•„í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
            });
        }

        // ì´ë¦„ í•„í„° ì˜µì…˜ ì¶”ê°€
        function initializeFilters(useSpecificDateFilter = false) {
            // ì´ë¦„ í•„í„° ì´ˆê¸°í™”
            const nameFilter = document.getElementById('nameFilter');
            
            nameFilter.innerHTML = '<option value="">ì „ì²´ ì´ë¦„</option>';
            
            const uniqueNames = [...new Set(people)];
            uniqueNames.forEach(person => {
                // í•„í„°ìš© ì˜µì…˜
                const filterOption = document.createElement('option');
                filterOption.value = person;
                filterOption.textContent = person;
                nameFilter.appendChild(filterOption);
            });

            // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
            const dateFilter = document.getElementById('dateFilter');
            dateFilter.innerHTML = '<option value="">ì „ì²´ ê¸°ê°„</option>';
            
            // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ 12ê°œì›” ì˜µì…˜ ìƒì„±
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const value = `${year}-${month.toString().padStart(2, '0')}`;
                const text = `${year}ë…„ ${month}ì›”`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                dateFilter.appendChild(option);
            }

            // í•„í„° ì»¨í…Œì´ë„ˆ ìš”ì†Œ
            const dateFilterType = document.getElementById('dateFilterType');
            const monthFilterContainer = document.getElementById('monthFilterContainer');
            const specificDateContainer = document.getElementById('specificDateContainer');
            
            // íŠ¹ì • ë‚ ì§œ í•„í„°ì˜ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ)
            const specificDateFilter = document.getElementById('specificDateFilter');
            const today = new Date();
            const formattedToday = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            specificDateFilter.value = formattedToday;
            
            // ë°˜ë“œì‹œ ê¸°ë³¸ê°’ì„ ëª¨ë‘ ë¹„ìš°ê³  ì‹œì‘
            dateFilter.value = '';
            activeFilters.date = '';
            
            if (useSpecificDateFilter) {
                // íŠ¹ì • ë‚ ì§œ í•„í„° ì‚¬ìš© (ì˜¤ëŠ˜ ë‚ ì§œ)
                dateFilterType.value = 'specific';
                monthFilterContainer.style.display = 'none';
                specificDateContainer.style.display = 'block';
                
                // í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
                activeFilters.specificDate = formattedToday;
                console.log('íŠ¹ì • ë‚ ì§œ í•„í„° ì„¤ì •:', formattedToday);
            } else {
                // ì›”ë³„ í•„í„° ì‚¬ìš© (í˜„ì¬ ì›”)
                const currentValue = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
                dateFilter.value = currentValue;
                activeFilters.date = currentValue;
                activeFilters.specificDate = '';
            }
            
            // ì½˜ì†”ì— í˜„ì¬ í•„í„° ìƒíƒœ ì¶œë ¥
            console.log('í•„í„° ì´ˆê¸°í™” ì™„ë£Œ. í˜„ì¬ í•„í„° ìƒíƒœ:', JSON.stringify(activeFilters));
            
            updateActiveFilters();
        }

        // ìš”ì¼ êµ¬í•˜ê¸°
        function getKoreanDayOfWeek(dateStr) {
            const date = new Date(dateStr);
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return days[date.getDay()];
        }

        // ë‚ ì§œë³„ ê·¸ë£¹í™” í•¨ìˆ˜
        function groupByDate(items) {
            const groups = {};
            
            items.forEach(item => {
                const date = new Date(item.receivedDate); // ë‹¬ë€íŠ¸ ë°›ì€ ë‚ ì§œ ê¸°ì¤€ ê·¸ë£¹í™”
                const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                if (!groups[dateKey]) {
                    groups[dateKey] = {
                        date: item.receivedDate,
                        items: [],
                        totalTalant: 0
                    };
                }
                
                groups[dateKey].items.push(item);
                groups[dateKey].totalTalant += parseInt(item.talant);
            });
            
            // ë‚ ì§œ ê¸°ì¤€ ì •ë ¬ (ìµœì‹ ìˆœ)
            return Object.values(groups).sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // ë‚´ì—­ í‘œì‹œ (ì¹´ë“œí˜•)
        function displayHistory(history) {
            console.log('í™”ë©´ í‘œì‹œ ì‹œì‘, ë°ì´í„° ìˆ˜:', history.length);
            const historyList = document.getElementById('historyList');
            const recordCount = document.getElementById('recordCount');
            
            recordCount.textContent = `${history.length}ê°œ`;
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-message">
                        <div class="empty-icon">ğŸ“‹</div>
                        <p>í‘œì‹œí•  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
            const groups = groupByDate(history);
            
            let html = '<div class="date-cards">';
            
            groups.forEach(group => {
                const groupDate = new Date(group.date);
                const formattedGroupDate = `${groupDate.getFullYear()}ë…„ ${groupDate.getMonth() + 1}ì›” ${groupDate.getDate()}ì¼`;
                const dayOfWeek = getKoreanDayOfWeek(group.date);
                
                html += `
                <div class="date-card">
                    <div class="date-card-header">
                        <div class="date-header-left">
                            <div class="date-text">${formattedGroupDate}</div>
                            <div class="date-day">${dayOfWeek}ìš”ì¼</div>
                        </div>
                        <div class="date-count">${group.items.length}ê°œ</div>
                    </div>
                    <div class="history-list">`;
                
                // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
                group.items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                group.items.forEach((item, index) => {
                    // ì§€ê¸‰ ë‚ ì§œì™€ ì‹œê°„ í¬ë§·íŒ…
                    const createdAt = new Date(item.timestamp);
                    const createdAtStr = `${createdAt.getFullYear()}-${(createdAt.getMonth() + 1).toString().padStart(2, '0')}-${createdAt.getDate().toString().padStart(2, '0')} ${createdAt.getHours().toString().padStart(2, '0')}:${createdAt.getMinutes().toString().padStart(2, '0')}`;
                    
                    html += `
                        <div class="history-item" data-index="${index}">
                            <div class="history-content">
                                <div class="reason"><span class="name">${item.name}</span> - ${item.reason}</div>
                                <div class="created-at">ì§€ê¸‰ì¼ì‹œ: ${createdAtStr}</div>
                            </div>
                            <div class="actions">
                                <div class="talant">+${item.talant}</div>
                                <button class="delete-btn" onclick="confirmDelete('${item.id}')">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                </div>`;
            });
            
            html += '</div>';
            
            historyList.innerHTML = html;
        }

        // ì‚­ì œ í™•ì¸ í•¨ìˆ˜ ì¶”ê°€
        function confirmDelete(id) {
            const item = allHistory.find(item => item.id === id);
            if (!item) return;
            
            if (confirm(`ì •ë§ë¡œ ë‹¤ìŒ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ë¦„: ${item.name}\nì‚¬ìœ : ${item.reason}\në‹¬ë€íŠ¸: ${item.talant}`)) {
                // ì‹œê°ì  í”¼ë“œë°± ì¶”ê°€ (ì‚­ì œ ì¤‘ ìƒíƒœ í‘œì‹œ)
                const items = document.querySelectorAll('.history-item');
                items.forEach(el => {
                    if (el.querySelector('.delete-btn').onclick.toString().includes(id)) {
                        el.classList.add('deleting');
                    }
                });
                
                deleteHistoryItem(id);
            }
        }

        // ì‚­ì œ ì‹¤í–‰ í•¨ìˆ˜ ì¶”ê°€
        async function deleteHistoryItem(id) {
            try {
                showLoading();
                
                if (isUsingMockData) {
                    // ëª¨ì˜ ë°ì´í„°ì¼ ê²½ìš° ë°°ì—´ì—ì„œ ì œê±°
                    allHistory = allHistory.filter(item => item.id !== id);
                    setTimeout(() => {
                        applyFilters();
                        hideLoading();
                        showToast('ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    }, 500);
                } else {
                    // Firestoreì—ì„œ ë¬¸ì„œ ì‚­ì œ
                    await talantCollection.doc(id).delete();
                    showToast('ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    await loadHistory();
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 5000);
                hideLoading();
            }
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            console.log('í•„í„° ì ìš© ì‹œì‘, í˜„ì¬ í•„í„° ìƒíƒœ:', JSON.stringify(activeFilters));
            
            const nameFilter = document.getElementById('nameFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const specificDateFilter = document.getElementById('specificDateFilter').value;
            const dateFilterType = document.getElementById('dateFilterType').value;
            
            console.log('í˜„ì¬ UI í•„í„° ê°’:', {
                name: nameFilter,
                dateType: dateFilterType,
                date: dateFilter,
                specificDate: specificDateFilter
            });
            
            // í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
            const hasChanges = 
                (activeFilters.name !== nameFilter) || 
                (activeFilters.date !== dateFilter) ||
                (activeFilters.specificDate !== specificDateFilter);
            
            // ê¸°ì¡´ í•„í„° ê°’ ì €ì¥
            activeFilters.name = nameFilter;
            
            // ë‚ ì§œ í•„í„° íƒ€ì…ì— ë”°ë¼ í•„í„° ì„¤ì •
            if (dateFilterType === 'month') {
                activeFilters.date = dateFilter;
                activeFilters.specificDate = '';
                // UIì—ì„œë„ íŠ¹ì • ë‚ ì§œ í•„í„° ì…ë ¥ í•„ë“œë¥¼ ë¹„ì›€
                document.getElementById('specificDateFilter').value = '';
            } else {
                activeFilters.date = '';
                activeFilters.specificDate = specificDateFilter;
                // UIì—ì„œë„ ì›”ë³„ í•„í„° ì…ë ¥ í•„ë“œë¥¼ ë¹„ì›€
                document.getElementById('dateFilter').value = '';
            }
            
            if (hasChanges) {
                updateActiveFilters();
            }

            console.log('í•„í„° ì ìš© ì „ ìƒíƒœ ì—…ë°ì´íŠ¸:', JSON.stringify(activeFilters));

            let filtered = [...allHistory];
            console.log('ì „ì²´ ë°ì´í„° ìˆ˜:', filtered.length);

            if (nameFilter) {
                filtered = filtered.filter(item => item.name === nameFilter);
                console.log('ì´ë¦„ í•„í„° í›„ ë°ì´í„° ìˆ˜:', filtered.length);
            }

            // ì›”ë³„ í•„í„°ì™€ íŠ¹ì • ë‚ ì§œ í•„í„°ëŠ” ìƒí˜¸ ë°°íƒ€ì 
            if (activeFilters.date) {
                console.log('ì›”ë³„ í•„í„° ì ìš©:', activeFilters.date);
                const [year, month] = activeFilters.date.split('-');
                filtered = filtered.filter(item => {
                    const date = new Date(item.receivedDate);
                    return date.getFullYear() === parseInt(year) && 
                           date.getMonth() === parseInt(month) - 1;
                });
                console.log('ì›”ë³„ í•„í„° í›„ ë°ì´í„° ìˆ˜:', filtered.length);
            }
            
            if (activeFilters.specificDate) {
                console.log('íŠ¹ì • ë‚ ì§œ í•„í„° ì ìš©:', activeFilters.specificDate);
                const selectedDate = new Date(activeFilters.specificDate);
                selectedDate.setHours(0, 0, 0, 0); // ì‹œê°„ ë¶€ë¶„ì„ 0ìœ¼ë¡œ ì„¤ì •
                
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.receivedDate);
                    itemDate.setHours(0, 0, 0, 0); // ì‹œê°„ ë¶€ë¶„ì„ 0ìœ¼ë¡œ ì„¤ì •
                    
                    // ë‚ ì§œ ë¹„êµ
                    const isMatch = itemDate.getTime() === selectedDate.getTime();
                    return isMatch;
                });
                console.log('íŠ¹ì • ë‚ ì§œ í•„í„° í›„ ë°ì´í„° ìˆ˜:', filtered.length);
            }

            displayHistory(filtered);
            
            if (hasChanges) {
                let toastMessage = '';
                
                if (nameFilter) {
                    toastMessage += `ì´ë¦„: ${nameFilter}`;
                }
                
                if (activeFilters.date) {
                    if (toastMessage) toastMessage += ', ';
                    toastMessage += `ê¸°ê°„: ${activeFilters.date.split('-')[0]}ë…„ ${activeFilters.date.split('-')[1]}ì›”`;
                }
                
                if (activeFilters.specificDate) {
                    if (toastMessage) toastMessage += ', ';
                    const specDate = new Date(activeFilters.specificDate);
                    toastMessage += `ë‚ ì§œ: ${specDate.getFullYear()}ë…„ ${specDate.getMonth() + 1}ì›” ${specDate.getDate()}ì¼`;
                }
                
                if (toastMessage) {
                    showToast(`${toastMessage} í•„í„° ì ìš©ë¨`);
                } else {
                    showToast('ëª¨ë“  í•„í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            }
        }

        // Firebase ì´ˆê¸°í™”
        async function initializeFirebase() {
            try {
                showLoading();
                hideError();
                
                console.log('Firebase ì´ˆê¸°í™” ì‹œë„...');
                
                // ì´ë¯¸ ì´ˆê¸°í™”ëœ ê²½ìš° ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
                if (!firebaseInitialized) {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    talantCollection = db.collection('talant_history');
                    firebaseInitialized = true;
                }
                
                // ì—°ê²° í…ŒìŠ¤íŠ¸
                await db.collection('talant_history').limit(1).get();
                
                console.log('Firebase ì—°ê²° ì„±ê³µ');
                isUsingMockData = false;
                
                // í•„í„° ì´ˆê¸°í™”
                initializeFilters();
                
                // ë°ì´í„° ë¡œë“œ
                await loadHistory();
                
                hideLoading();
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                hideLoading();
                showError('Firebase ì—°ê²° ì˜¤ë¥˜', 'ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }
        }

        // ëª©ì—… ë°ì´í„° ì‚¬ìš©
        function useMockData() {
            hideError();
            showLoading();
            
            console.log('ëª©ì—… ë°ì´í„° ì‚¬ìš© ì¤‘...');
            isUsingMockData = true;
            
            // í•„í„° ì´ˆê¸°í™”
            initializeFilters(true); // íŠ¹ì • ë‚ ì§œ(ì˜¤ëŠ˜) í•„í„°ë¡œ ì‹œì‘
            
            // ëª©ì—… ë°ì´í„° ì„¤ì •
            allHistory = [...mockData];
            
            // í•„í„° ì ìš©
            setTimeout(() => {
                applyFilters();
                hideLoading();
                showToast('í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤', 3000);
            }, 500);
        }

        // ë°ì´í„° ë¡œë“œ (Firebase)
        async function loadHistory() {
            try {
                showLoading();
                console.log('Firebaseì—ì„œ ë°ì´í„° ë¡œë”© ì‹œì‘...');
                
                // Firestoreì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const snapshot = await talantCollection.orderBy('receivedDate', 'desc').get();
                
                console.log('ë°ì´í„° ë¡œë“œ ì„±ê³µ, ë¬¸ì„œ ìˆ˜:', snapshot.size);
                
                if (snapshot.empty) {
                    console.log('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    allHistory = [];
                    applyFilters();
                    hideLoading();
                    return;
                }
                
                allHistory = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        timestamp: data.createdAt ? data.createdAt.toDate() : new Date(), // ì§€ê¸‰í•œ ì‹œê°„
                        receivedDate: data.receivedDate ? data.receivedDate.toDate() : new Date(), // ë‹¬ë€íŠ¸ ë°›ì€ ë‚ ì§œ
                        name: data.name || '',
                        talant: data.talant || '0',
                        reason: data.reason || '(ì‚¬ìœ  ì—†ìŒ)'
                    };
                });
                
                console.log('ë°ì´í„° ë³€í™˜ ì™„ë£Œ, í•­ëª© ìˆ˜:', allHistory.length);
                
                // í˜„ì¬ í•„í„° ìƒíƒœ ì¶œë ¥
                console.log('ë°ì´í„° ë¡œë“œ í›„ í•„í„° ìƒíƒœ:', JSON.stringify(activeFilters));
                
                // í•„í„° ì ìš©
                applyFilters();
                
                hideLoading();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'ë‹¬ë€íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                hideLoading();
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        function addEventListeners() {
            const nameFilter = document.getElementById('nameFilter');
            const dateFilter = document.getElementById('dateFilter');
            const specificDateFilter = document.getElementById('specificDateFilter');
            const dateFilterType = document.getElementById('dateFilterType');
            
            nameFilter.addEventListener('change', () => {
                applyFilters();
            });
            
            dateFilter.addEventListener('change', () => {
                applyFilters();
            });
            
            specificDateFilter.addEventListener('change', () => {
                applyFilters();
            });
            
            dateFilterType.addEventListener('change', () => {
                const monthFilterContainer = document.getElementById('monthFilterContainer');
                const specificDateContainer = document.getElementById('specificDateContainer');
                
                if (dateFilterType.value === 'month') {
                    monthFilterContainer.style.display = 'block';
                    specificDateContainer.style.display = 'none';
                    
                    // íŠ¹ì • ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
                    document.getElementById('specificDateFilter').value = '';
                    activeFilters.specificDate = '';
                } else {
                    monthFilterContainer.style.display = 'none';
                    specificDateContainer.style.display = 'block';
                    
                    // ì›”ë³„ í•„í„° ì´ˆê¸°í™”
                    document.getElementById('dateFilter').value = '';
                    activeFilters.date = '';
                }
                
                updateActiveFilters();
                applyFilters();
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('í˜ì´ì§€ ë¡œë“œë¨');
            addEventListeners();
            
            // Firebase ì´ˆê¸°í™”
            try {
                initializeFirebase();
                
                // ì´ˆê¸°í™” í›„ í•„í„° ì •ìƒ ì ìš©ì„ ìœ„í•´ ì§€ì—° ì‹¤í–‰
                setTimeout(() => {
                    applyFilters();
                }, 100);
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì´ˆê¸°í™” ì˜¤ë¥˜', 'ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
                hideLoading();
            }
        });
    </script>
</body>
</html>
