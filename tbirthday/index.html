<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>월별 생일자 목록</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.8/static/pretendard.css">
    <script src="https://cdn.jsdelivr.net/npm/solarlunar/lib/solarlunar.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: #F5F5F7;
            padding: 20px;
            color: #1A1A1A;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 560px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(123, 74, 255, 0.08);
        }

        .page-title {
            font-size: 32px;
            font-weight: bold;
            color: #1A1A1A;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #7B4AFF;
            margin-bottom: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .controls {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-top: 24px;
        }
        
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .filter-stats {
            color: #7B4AFF;
            font-size: 14px;
            font-weight: 500;
        }
        
        .reset-button {
            background: none;
            border: none;
            color: #666666;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            padding: 4px 8px;
        }
        
        .reset-button:hover {
            color: #7B4AFF;
        }

        select {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid #DDDDDD;
            font-size: 16px;
            background-color: white;
            color: #666666;
            width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%237B4AFF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #7B4AFF;
            box-shadow: 0 0 0 2px rgba(123, 74, 255, 0.2);
        }

        .select-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .select-label {
            color: #666666;
            font-size: 14px;
            font-weight: 500;
        }

        .birthday-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: #F5F5F7;
            border-radius: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .birthday-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .birthday-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #7B4AFF;
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
        }

        .name-position {
            font-size: 18px;
            font-weight: 600;
            color: #1A1A1A;
        }

        .department {
            font-size: 14px;
            color: #666666;
            margin-top: 4px;
        }

        .birthday-info {
            background-color: white;
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #7B4AFF;
            border: 1px solid rgba(123, 74, 255, 0.2);
        }

        .no-birthdays {
            text-align: center;
            padding: 32px 20px;
            color: #666666;
            background-color: #F5F5F7;
            border-radius: 16px;
            font-size: 16px;
        }

        .timestamp {
            text-align: center;
            font-size: 14px;
            margin-top: 32px;
            color: #666666;
        }
        
        .dot-decoration {
            display: flex;
            justify-content: center;
            margin: 16px 0;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #DDDDDD;
            margin: 0 4px;
        }
        
        .dot.active {
            background-color: #7B4AFF;
        }
        
        /* 로딩 애니메이션 */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #666666;
            gap: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(123, 74, 255, 0.2);
            border-radius: 50%;
            border-top-color: #7B4AFF;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 재시도 버튼 */
        .retry-button {
            background-color: #7B4AFF;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            margin-top: 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .retry-button:hover {
            background-color: #6B3AD8;
        }
        
        /* 생일 카드 트랜지션 개선 */
        .birthday-list {
            position: relative;
        }
        
        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: #F5F5F7;
            border-radius: 16px;
            transition: all 0.2s ease-out;
            position: relative;
            transform-origin: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 560px) {
            .container {
                padding: 24px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .select-group {
                width: 100%;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .section-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">월별 생일자 목록</h1>
            <h2 class="section-title">생일을 축하합니다</h2>
        </div>
        
        <div class="filter-section">
            <div class="filter-header">
                <div class="filter-stats" id="filterStats">총 0명</div>
                <button id="resetFilters" class="reset-button">필터 초기화</button>
            </div>
            <div class="controls">
                <div class="select-group">
                    <label class="select-label">월 선택</label>
                    <select id="monthSelect">
                        <option value="all">전체</option>
                        <option value="1">1월</option>
                        <option value="2">2월</option>
                        <option value="3">3월</option>
                        <option value="4">4월</option>
                        <option value="5">5월</option>
                        <option value="6">6월</option>
                        <option value="7">7월</option>
                        <option value="8">8월</option>
                        <option value="9">9월</option>
                        <option value="10">10월</option>
                        <option value="11">11월</option>
                        <option value="12">12월</option>
                    </select>
                </div>
                <div class="select-group">
                    <label class="select-label">소속 선택</label>
                    <select id="departmentSelect">
                        <option value="all">전체</option>
                        <option value="장년부">장년부</option>
                        <option value="청년부">청년부</option>
                        <option value="고등부">고등부</option>
                        <option value="중등부">중등부</option>
                        <option value="주일학교">주일학교</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="dot-decoration">
            <div class="dot active"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        
        <div id="birthdayList" class="birthday-list"></div>
        
        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwKMY7UDajbisVm_UgLr1cEuib5de1rNk0t3P_hV9HYues7f_aWNFXr54en0miE40lWuA/exec';
        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24시간 (밀리초)
        const CURRENT_YEAR = new Date().getFullYear(); // 2025년
        let birthdayData = [];
        let cachedFilteredData = [];
        let isLoading = false;
        
        // 음력 날짜를 올해 양력 날짜로 변환하는 함수
        function convertLunarToSolar(lunarDateStr, type) {
            if (type !== '음력' && type !== '음') {
                return null; // 양력이면 변환 불필요
            }
            
            try {
                // 날짜 문자열 파싱 (예: "06월 01일" 또는 "06.01" 또는 "6.1")
                const match = lunarDateStr.match(/(\d{1,2})[월.\s]+(\d{1,2})/);
                if (!match) return null;
                
                const lunarMonth = parseInt(match[1], 10);
                const lunarDay = parseInt(match[2], 10);
                
                // solarlunar.js를 사용하여 음력을 양력으로 변환
                // CDN 버전에서는 전역 변수로 접근 가능
                let solar = null;
                
                // 여러 가능한 전역 변수 이름 시도
                if (typeof solarLunar !== 'undefined' && solarLunar.lunarToSolar) {
                    solar = solarLunar.lunarToSolar(CURRENT_YEAR, lunarMonth, lunarDay);
                } else if (typeof solarlunar !== 'undefined' && solarlunar.lunarToSolar) {
                    solar = solarlunar.lunarToSolar(CURRENT_YEAR, lunarMonth, lunarDay);
                } else if (typeof window.solarLunar !== 'undefined' && window.solarLunar.lunarToSolar) {
                    solar = window.solarLunar.lunarToSolar(CURRENT_YEAR, lunarMonth, lunarDay);
                }
                
                if (solar && solar.year && solar.month && solar.day) {
                    return new Date(solar.year, solar.month - 1, solar.day);
                }
                
                // 변환 실패 시 null 반환
                return null;
            } catch (error) {
                console.error('음력 변환 오류:', error, lunarDateStr);
                return null;
            }
        }
        
        // 데이터에 actualSolarDate 추가하는 함수
        function processBirthdayData(data) {
            return data.map(person => {
                let actualSolarDate = null;
                const isLunar = person.type === '음력' || person.type === '음';
                
                if (isLunar) {
                    // 음력 생일인 경우 올해 양력으로 변환
                    actualSolarDate = convertLunarToSolar(person.birthday, person.type);
                } else {
                    // 양력 생일인 경우 그대로 사용 (올해 기준으로 날짜 생성)
                    try {
                        const dateMatch = person.birthday.match(/(\d{1,2})[월.\s]+(\d{1,2})/);
                        if (dateMatch) {
                            const month = parseInt(dateMatch[1], 10);
                            const day = parseInt(dateMatch[2], 10);
                            actualSolarDate = new Date(CURRENT_YEAR, month - 1, day);
                        }
                    } catch (error) {
                        console.error('양력 날짜 파싱 오류:', error);
                    }
                }
                
                return {
                    ...person,
                    actualSolarDate: actualSolarDate,
                    isLunar: isLunar
                };
            });
        }
        
        // 날짜 포맷팅 함수 (표기 방식 변경)
        function formatDate(person) {
            if (person.isLunar) {
                // 음력 생일자: 원래 음력 날짜 (올해 양력: MM월 DD일) (음력)
                const originalLunar = person.birthday.replace(/[월일]/g, '.').replace(/\s/g, '');
                if (person.actualSolarDate) {
                    const solarMonth = person.actualSolarDate.getMonth() + 1;
                    const solarDay = person.actualSolarDate.getDate();
                    return `음 ${originalLunar} (올해 양력 ${solarMonth}월 ${solarDay}일) (음력)`;
                } else {
                    // 변환 실패 시 원래 형식 유지
                    return `${person.birthday} (음력)`;
                }
            } else {
                // 양력 생일자: MM월 DD일
                return person.birthday;
            }
        }

        function getMonthFromDate(person) {
            if (person.actualSolarDate) {
                return person.actualSolarDate.getMonth() + 1;
            }
            // fallback: 원래 날짜에서 추출
            const match = person.birthday.match(/(\d{1,2})/);
            return match ? parseInt(match[1], 10) : 1;
        }

        // 디바운스 처리를 위한 함수
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 로딩 상태 표시 함수
        function showLoading() {
            isLoading = true;
            document.getElementById('birthdayList').innerHTML = 
                '<div class="loading"><div class="loading-spinner"></div><div>데이터를 불러오는 중...</div></div>';
        }

        // 필터링 및 정렬을 한번에 처리하는 함수
        function filterBirthdays() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedDepartment = document.getElementById('departmentSelect').value;
            
            // 로컬 스토리지에 선택값 저장
            localStorage.setItem('selectedMonth', selectedMonth);
            localStorage.setItem('selectedDepartment', selectedDepartment);
            
            // 보여주기 전에 로딩 상태 표시
            if (isLoading) {
                showLoading();
            }
            
            // UI 렌더링을 다음 프레임으로 지연
            requestAnimationFrame(() => {
                let filteredData = birthdayData;
    
                // 월 필터링 (actualSolarDate 기준)
                if (selectedMonth !== 'all') {
                    const monthInt = parseInt(selectedMonth);
                    filteredData = filteredData.filter(person => 
                        getMonthFromDate(person) === monthInt
                    );
                }
    
                // 소속 필터링
                if (selectedDepartment !== 'all') {
                    filteredData = filteredData.filter(person => person.소속 === selectedDepartment);
                }
    
                // actualSolarDate 기준으로 정렬 (올해 생일이 빠른 순서대로)
                if (!arraysEqual(filteredData, cachedFilteredData)) {
                    filteredData.sort((a, b) => {
                        // actualSolarDate가 없는 경우를 처리
                        if (!a.actualSolarDate && !b.actualSolarDate) return 0;
                        if (!a.actualSolarDate) return 1;
                        if (!b.actualSolarDate) return -1;
                        
                        // 날짜 비교
                        return a.actualSolarDate.getTime() - b.actualSolarDate.getTime();
                    });
                    
                    cachedFilteredData = filteredData;
                }
    
                renderBirthdayList(filteredData);
                isLoading = false;
            });
        }
        
        // 배열 비교 함수
        function arraysEqual(a, b) {
            if (a === b) return true;
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // 렌더링 함수 분리
        function renderBirthdayList(data) {
            const birthdayList = document.getElementById('birthdayList');
            
            if (data.length === 0) {
                birthdayList.innerHTML = '<div class="no-birthdays">해당하는 생일자가 없습니다.</div>';
                return;
            }
            
            // DOM 조작 최소화
            const fragment = document.createDocumentFragment();
            
            data.forEach(person => {
                const item = document.createElement('div');
                item.className = 'birthday-item';
                
                const personInfo = document.createElement('div');
                personInfo.className = 'person-info';
                
                const namePosition = document.createElement('div');
                namePosition.className = 'name-position';
                namePosition.textContent = `${person.name} ${person.position || ''}`;
                
                const department = document.createElement('div');
                department.className = 'department';
                department.textContent = person.소속 || '';
                
                personInfo.appendChild(namePosition);
                personInfo.appendChild(department);
                
                const birthdayInfo = document.createElement('div');
                birthdayInfo.className = 'birthday-info';
                birthdayInfo.textContent = formatDate(person);
                
                item.appendChild(personInfo);
                item.appendChild(birthdayInfo);
                fragment.appendChild(item);
            });
            
            // 한 번에 DOM 갱신
            birthdayList.innerHTML = '';
            birthdayList.appendChild(fragment);
            
            // 필터링 결과 통계 업데이트
            updateFilterStats(data.length);
        }
        
        // 필터링 결과 통계 표시
        function updateFilterStats(count) {
            const stats = document.getElementById('filterStats');
            if (stats) {
                stats.textContent = `총 ${count}명`;
            }
        }
        
        // 디바운스된 필터 함수
        const debouncedFilter = debounce(filterBirthdays, 100);
        
        // 필터 변경 이벤트 리스너
        function setupEventListeners() {
            const monthSelect = document.getElementById('monthSelect');
            const departmentSelect = document.getElementById('departmentSelect');
            
            monthSelect.addEventListener('change', debouncedFilter);
            departmentSelect.addEventListener('change', debouncedFilter);
            
            // 필터 리셋 버튼 이벤트
            const resetButton = document.getElementById('resetFilters');
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    monthSelect.value = 'all';
                    departmentSelect.value = 'all';
                    debouncedFilter();
                });
            }
        }

        // localStorage에서 캐시된 데이터 확인
        function getCachedData() {
            try {
                const cached = localStorage.getItem('birthdayDataCache');
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                const now = new Date().getTime();
                
                // 24시간 이내의 캐시인지 확인
                if (now - timestamp < CACHE_DURATION) {
                    return data;
                } else {
                    // 만료된 캐시 삭제
                    localStorage.removeItem('birthdayDataCache');
                    return null;
                }
            } catch (error) {
                console.error('캐시 읽기 오류:', error);
                return null;
            }
        }
        
        // localStorage에 데이터 캐싱
        function setCachedData(data) {
            try {
                const cache = {
                    data: data,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('birthdayDataCache', JSON.stringify(cache));
            } catch (error) {
                console.error('캐시 저장 오류:', error);
            }
        }
        
        // 데이터 초기 로드
        async function loadBirthdayData() {
            // 캐시된 데이터 확인
            const cachedData = getCachedData();
            if (cachedData) {
                // 캐시에서 데이터 로드
                birthdayData = cachedData;
                restoreFilterSettings();
                filterBirthdays();
                updateTimestamp();
                return; // 네트워크 요청 건너뛰기
            }
            
            // 캐시가 없거나 만료된 경우 네트워크에서 로드
            showLoading();
            
            try {
                // 캐시 버스팅을 위한 타임스탬프 추가
                const timestamp = new Date().getTime();
                const url = `${scriptURL}?t=${timestamp}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('네트워크 응답이 올바르지 않습니다');
                }
                
                const data = await response.json();
                let rawData = data.birthdays;
                
                // 데이터 가공: actualSolarDate 계산
                rawData = processBirthdayData(rawData);
                
                // 캐시에 저장
                setCachedData(rawData);
                
                birthdayData = rawData;
                
                // 초기 필터 값 설정 (로컬 스토리지에서 복원)
                restoreFilterSettings();
                
                // 필터 적용
                filterBirthdays();
                
                // 마지막 업데이트 시간 표시
                updateTimestamp();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('birthdayList').innerHTML = 
                    '<div class="no-birthdays">데이터를 불러오는데 실패했습니다.<br><button id="retryButton" class="retry-button">다시 시도</button></div>';
                
                // 재시도 버튼 이벤트 리스너
                const retryButton = document.getElementById('retryButton');
                if (retryButton) {
                    retryButton.addEventListener('click', loadBirthdayData);
                }
            } finally {
                isLoading = false;
            }
        }
        
        // 필터 설정 복원
        function restoreFilterSettings() {
            const monthSelect = document.getElementById('monthSelect');
            const departmentSelect = document.getElementById('departmentSelect');
            
            // 저장된 값이 있으면 복원, 없으면 현재 월 설정
            const savedMonth = localStorage.getItem('selectedMonth');
            const savedDepartment = localStorage.getItem('selectedDepartment');
            
            monthSelect.value = savedMonth || new Date().getMonth() + 1;
            departmentSelect.value = savedDepartment || 'all';
        }
        
        // 타임스탬프 업데이트
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = 
                `마지막 업데이트: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadBirthdayData();
        });
    </script>
</body>
</html>
